# 管理员登录问题排查指南

## 快速诊断

### 1. 检查管理员账户状态

```bash
cd /www/wwwroot/dy.moneyfly.top
go run scripts/check_admin.go
```

这会显示：
- 所有管理员账户信息
- 账户状态（IsActive, IsVerified, IsAdmin）
- 密码哈希格式
- 账户是否正常

### 2. 测试密码验证

```bash
# 测试默认密码
go run scripts/check_admin.go admin123

# 或测试您的密码
go run scripts/check_admin.go your_password
```

## 常见问题和解决方案

### 问题 1: "用户名或密码错误"

**可能原因：**
1. 密码不正确
2. 使用了错误的登录页面
3. 密码哈希格式异常

**解决方法：**

#### 步骤 1: 检查账户状态
```bash
go run scripts/check_admin.go
```

#### 步骤 2: 重新创建管理员账户
```bash
# 使用默认密码
go run scripts/create_admin.go

# 或使用自定义密码
ADMIN_PASSWORD=your_strong_password go run scripts/create_admin.go
```

#### 步骤 3: 确认使用正确的登录页面
- ✅ **正确**: `http://your-domain.com/admin/login` (管理员登录页面)
- ❌ **错误**: `http://your-domain.com/login` (普通用户登录页面)

#### 步骤 4: 测试密码验证
```bash
go run scripts/check_admin.go your_password
```

### 问题 2: "账户已被禁用"

**解决方法：**
```bash
# 使用解锁脚本
go run unlock_admin.go admin
```

### 问题 3: "该账户不是管理员"

**解决方法：**
```bash
# 重新创建管理员账户，确保 IsAdmin=true
go run scripts/create_admin.go
```

### 问题 4: 登录后立即退出

**可能原因：**
1. 账户状态异常（IsActive=false）
2. Token 验证失败
3. 前端路由守卫问题

**解决方法：**
1. 检查账户状态：`go run scripts/check_admin.go`
2. 解锁账户：`go run unlock_admin.go admin`
3. 清除浏览器缓存和 Cookie
4. 使用无痕模式重试

## 详细排查步骤

### 步骤 1: 检查数据库中的管理员账户

```bash
cd /www/wwwroot/dy.moneyfly.top

# 使用 SQLite 命令行工具（如果安装了）
sqlite3 cboard.db "SELECT id, username, email, is_admin, is_active, is_verified FROM users WHERE is_admin = 1;"
```

### 步骤 2: 检查密码哈希

```bash
# 查看密码哈希
sqlite3 cboard.db "SELECT username, substr(password, 1, 20) as hash_preview FROM users WHERE is_admin = 1;"
```

密码哈希应该：
- 长度至少 60 字符
- 以 `$2a$`, `$2b$` 或 `$2y$` 开头（bcrypt 格式）

### 步骤 3: 验证登录 API

```bash
# 测试登录 API（替换为您的实际值）
curl -X POST http://localhost:8000/api/v1/auth/login-json \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### 步骤 4: 检查服务器日志

```bash
# 查看后端日志
tail -f /www/wwwroot/dy.moneyfly.top/server.log

# 或查看 systemd 日志
journalctl -u cboard -f
```

## 重置管理员账户

如果以上方法都无法解决，可以完全重置管理员账户：

```bash
cd /www/wwwroot/dy.moneyfly.top

# 1. 删除旧的管理员账户（可选，谨慎操作）
sqlite3 cboard.db "DELETE FROM users WHERE username = 'admin' OR email = 'admin@example.com';"

# 2. 重新创建管理员账户
go run scripts/create_admin.go

# 或使用自定义密码
ADMIN_PASSWORD=your_new_password go run scripts/create_admin.go
```

## 验证登录

创建账户后，验证步骤：

1. **检查账户状态**
   ```bash
   go run scripts/check_admin.go
   ```

2. **测试密码验证**
   ```bash
   go run scripts/check_admin.go your_password
   ```

3. **访问管理员登录页面**
   - URL: `http://your-domain.com/admin/login`
   - 用户名: `admin` 或 `admin@example.com`
   - 密码: 您设置的密码（或默认 `admin123`）

4. **检查浏览器控制台**
   - 打开开发者工具（F12）
   - 查看 Console 和 Network 标签页
   - 检查是否有错误信息

## 默认账户信息

如果使用默认设置：
- **用户名**: `admin`
- **邮箱**: `admin@example.com`
- **密码**: `admin123`

⚠️ **重要**: 生产环境请务必设置强密码！

## 获取帮助

如果问题仍然存在，请提供以下信息：

1. 诊断脚本输出：`go run scripts/check_admin.go`
2. 服务器日志：`tail -50 server.log`
3. 浏览器控制台错误信息
4. 具体的错误提示信息

