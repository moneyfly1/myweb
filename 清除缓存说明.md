# 解决部署后界面缓存问题

## 问题描述
部署新代码到 VPS 服务器后，浏览器仍然显示旧内容，这是因为浏览器缓存了旧的静态资源。

## 已实施的解决方案

### 1. Nginx 配置优化
- ✅ **禁止 `index.html` 缓存**：确保每次访问都获取最新的 HTML 文件
- ✅ **静态资源长期缓存**：JS/CSS 等文件（文件名包含 hash）可以长期缓存，因为文件名变化后浏览器会自动请求新文件

### 2. 构建配置优化
- ✅ **自动清理旧构建文件**：部署脚本会在构建前清理旧的 `dist` 目录
- ✅ **文件名包含 hash**：Vite 构建时自动为文件名添加 hash（如 `index.abc123.js`）

## 部署后的操作步骤

### 方法一：重新部署（推荐）
```bash
# 在服务器上执行
cd /www/wwwroot/dy.moneyfly.top
bash bt-deploy.sh
```

部署脚本会自动：
1. 清理旧的 `frontend/dist` 目录
2. 重新构建前端
3. 更新 Nginx 配置
4. 重启服务

### 方法二：手动清除缓存
如果已经部署完成，只需要：

1. **重新加载 Nginx 配置**：
```bash
nginx -t  # 检查配置
nginx -s reload  # 重新加载配置
```

2. **清除浏览器缓存**：
   - Chrome/Edge: `Ctrl+Shift+Delete` (Windows) 或 `Cmd+Shift+Delete` (Mac)
   - 或者使用无痕模式访问
   - 或者强制刷新：`Ctrl+F5` (Windows) 或 `Cmd+Shift+R` (Mac)

3. **清除 CDN 缓存**（如果使用了 CDN）：
   - 在 CDN 控制台清除缓存
   - 或者等待缓存过期

### 方法三：添加版本号查询参数（临时方案）
如果急需让用户看到新内容，可以在访问时添加版本号：
```
https://your-domain.com/?v=20240101
```

## 验证方法

1. **检查 `index.html` 响应头**：
```bash
curl -I https://your-domain.com/index.html
```
应该看到：
```
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
```

2. **检查静态资源文件名**：
查看 `dist/assets/` 目录，文件名应该包含 hash：
```
index.abc123.js
index.def456.css
```

3. **浏览器开发者工具**：
- 打开开发者工具 (F12)
- 切换到 Network 标签
- 勾选 "Disable cache"
- 刷新页面，查看资源是否从服务器获取

## 常见问题

### Q: 为什么部署后还是看到旧内容？
A: 可能是：
1. 浏览器缓存未清除 - 使用强制刷新 (`Ctrl+F5`)
2. Nginx 配置未重新加载 - 执行 `nginx -s reload`
3. 使用了 CDN - 需要清除 CDN 缓存

### Q: 如何确保用户立即看到更新？
A: 
1. 确保 `index.html` 不被缓存（已配置）
2. 确保静态资源文件名包含 hash（已配置）
3. 用户首次访问会获取新的 `index.html`，然后加载新的 JS/CSS 文件

### Q: 可以完全禁用缓存吗？
A: 不推荐。完全禁用缓存会影响性能。当前方案是最佳实践：
- `index.html` 不缓存（确保获取最新版本）
- 静态资源长期缓存（文件名变化后自动失效）

## 技术说明

### 工作原理
1. Vite 构建时自动为文件名添加 hash（基于文件内容）
2. 当代码更新时，文件内容变化，hash 也会变化
3. `index.html` 中引用的文件名会更新（如 `index.old123.js` → `index.new456.js`）
4. 浏览器请求 `index.html`（不缓存），获取新的文件名
5. 浏览器请求新的 JS/CSS 文件（旧文件名的缓存不会影响新文件）

### 为什么这样设计？
- **性能优化**：静态资源可以长期缓存，减少服务器压力
- **自动更新**：文件名变化后，浏览器自动请求新文件
- **兼容性好**：适用于所有现代浏览器

