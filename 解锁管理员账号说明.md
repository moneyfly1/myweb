# 解锁管理员账号和修复登录问题

## 问题描述
1. 管理员账号被锁定
2. 登录成功后立即被退出

## 已实施的修复

### 1. 更新了 `UnlockUserLogin` 函数
- ✅ 清除登录失败记录（`login_attempts` 表）
- ✅ 确保用户状态为激活（`IsActive = true`）

### 2. 修复了 `LoginJSON` 函数
- ✅ 添加了用户状态检查（`IsActive`）
- ✅ 如果用户被禁用，会返回明确的错误信息

### 3. 创建了解锁脚本
- ✅ `unlock_admin.go` - 用于直接解锁管理员账号

## 使用方法

### 方法一：使用解锁脚本（推荐）

在服务器上执行：

```bash
cd /www/wwwroot/dy.moneyfly.top  # 或您的项目目录
go run unlock_admin.go admin     # 使用用户名
# 或
go run unlock_admin.go admin@example.com  # 使用邮箱
```

脚本会：
1. 查找管理员账户
2. 显示登录失败记录统计
3. 清除所有登录记录（包括成功和失败的）
4. 确保账户状态为激活（`IsActive = true`, `IsVerified = true`）
5. 提供详细的诊断信息和解决方案

**重要提示**：
- 脚本会清除数据库中的登录记录，但**不会清除内存中的速率限制**
- 如果 IP 地址被速率限制器锁定，需要：
  - 等待 15 分钟后重试
  - 或更换 IP 地址（使用 VPN 或移动网络）
  - 或重启服务器以清除内存中的速率限制记录

### 方法二：通过 API 解锁（需要其他管理员权限）

如果您有其他管理员账户可以登录，可以通过 API 解锁：

```bash
# 获取管理员 token
TOKEN="your_admin_token"

# 获取管理员用户 ID（假设为 1）
curl -X POST "http://your-domain.com/api/v1/admin/users/1/unlock-login" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"
```

### 方法三：直接修改数据库（不推荐，仅紧急情况）

如果以上方法都不行，可以直接修改数据库：

```sql
-- 1. 查找管理员用户
SELECT id, username, email, is_active, is_verified FROM users WHERE is_admin = 1;

-- 2. 清除登录失败记录（假设管理员用户名为 'admin'）
DELETE FROM login_attempts WHERE username = 'admin' OR username = 'admin@example.com';

-- 3. 激活管理员账户（假设用户 ID 为 1）
UPDATE users SET is_active = 1, is_verified = 1 WHERE id = 1 AND is_admin = 1;
```

## 登录后立即退出的可能原因和解决方案

### 原因 1: 用户状态被禁用
**症状**: 登录成功但立即退出，后端返回 403 错误

**解决方案**:
- 使用解锁脚本解锁账户
- 或直接修改数据库：`UPDATE users SET is_active = 1 WHERE id = ?`

### 原因 2: Token 验证失败
**症状**: 登录成功但后续 API 请求返回 401

**可能原因**:
- Token 生成失败
- Token 过期时间设置错误
- Token 验证逻辑有问题

**检查方法**:
```bash
# 查看服务器日志
tail -f /www/wwwroot/dy.moneyfly.top/server.log

# 或查看系统日志
journalctl -u your-service-name -f
```

### 原因 3: 前端路由守卫问题
**症状**: 登录成功但页面跳转后立即返回登录页

**检查方法**:
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签页的错误信息
3. 查看 Network 标签页的 API 请求状态

**可能的问题**:
- Token 未正确保存到 localStorage/sessionStorage
- 路由守卫检查失败
- 用户信息解析错误

### 原因 4: IP 地址被速率限制器锁定
**症状**: 登录时提示"登录失败次数过多，账户已被临时锁定15分钟"

**重要说明**:
- Go 版本使用**基于 IP 地址的速率限制器**（内存中）
- 速率限制器独立于数据库中的登录尝试记录
- 锁定时间：**15 分钟**
- 限制：15 分钟内最多 5 次登录尝试

**解决方案**:
1. **等待 15 分钟**：锁定会自动解除
2. **更换 IP 地址**：使用 VPN 或移动网络
3. **重启服务器**：清除内存中的速率限制记录
4. **使用解锁脚本**：清除数据库中的登录记录（但不会清除内存限制）

**注意**：即使清除了数据库记录，如果 IP 被锁定，仍然需要等待或更换 IP。

## 验证修复

### 1. 检查用户状态
```bash
# 使用解锁脚本后，会显示用户状态
✅ 找到管理员账户:
   ID: 1
   用户名: admin
   邮箱: admin@example.com
   当前状态: IsActive=true, IsVerified=true
```

### 2. 检查登录失败记录
```sql
-- 应该返回 0 条记录（或很少的记录）
SELECT COUNT(*) FROM login_attempts 
WHERE username = 'admin' AND success = 0;
```

### 3. 测试登录
1. 清除浏览器缓存和 Cookie
2. 访问管理员登录页面
3. 使用正确的用户名和密码登录
4. 检查是否成功进入后台

## 预防措施

### 1. 定期检查账户状态
```sql
-- 检查所有管理员账户状态
SELECT id, username, email, is_active, is_verified, last_login 
FROM users 
WHERE is_admin = 1;
```

### 2. 监控登录失败记录
```sql
-- 查看最近的登录失败记录
SELECT username, ip_address, created_at 
FROM login_attempts 
WHERE success = 0 
ORDER BY created_at DESC 
LIMIT 10;
```

### 3. 设置合理的登录限制
在系统设置中配置：
- 登录失败次数限制（建议 5-10 次）
- 锁定时间（建议 15-30 分钟）

## 常见问题

### Q: 解锁脚本执行失败？
A: 检查：
1. 数据库连接是否正常
2. 用户名或邮箱是否正确
3. 该账户是否为管理员

### Q: 解锁后仍然无法登录？
A: 检查：
1. 密码是否正确
2. 用户状态是否为激活（`is_active = 1`）
3. 是否有其他安全限制（如 IP 白名单）

### Q: 如何重置管理员密码？
A: 可以使用数据库直接修改（需要知道密码哈希），或使用密码重置功能。

## 技术支持

如果以上方法都无法解决问题，请：
1. 检查服务器日志文件
2. 检查浏览器控制台错误
3. 检查数据库中的用户状态
4. 联系技术支持并提供错误日志

